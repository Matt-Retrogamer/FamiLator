{% extends "base.html" %}

{% block title %}Analyze ROM - FamiLator{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
                    <li class="breadcrumb-item active">Analyze: {{ filename }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <!-- ROM Info -->
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> ROM Information</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <td class="text-muted">Filename</td>
                            <td>{{ filename }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">CHR Type</td>
                            <td>
                                <span class="badge bg-info">{{ chr_analysis.chr_type }}</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted">Tile Count</td>
                            <td>{{ chr_analysis.total_tiles }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Font Regions</td>
                            <td>{{ chr_analysis.font_regions|length }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Latin Font</td>
                            <td>
                                {% if chr_analysis.has_latin_font %}
                                    <span class="badge bg-success">Yes</span>
                                {% else %}
                                    <span class="badge bg-warning">No</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted">Extended Charset</td>
                            <td>
                                {% if chr_analysis.has_extended_charset %}
                                    <span class="badge bg-success">Yes</span>
                                {% else %}
                                    <span class="badge bg-secondary">No</span>
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Language Detection -->
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-translate"></i> Language Detection</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="display-4 mb-2">
                            {% if lang_analysis.primary_language.value == 'japanese' %}
                                üáØüáµ
                            {% elif lang_analysis.primary_language.value == 'english' %}
                                üá∫üá∏
                            {% else %}
                                üåê
                            {% endif %}
                        </div>
                        <h4>{{ lang_analysis.primary_language.value|title }}</h4>
                        <div class="progress mt-3" style="height: 25px;">
                            <div class="progress-bar bg-danger" role="progressbar" 
                                 style="width: {{ (lang_analysis.confidence * 100)|round }}%">
                                {{ (lang_analysis.confidence * 100)|round }}% Confidence
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h6 class="text-muted">Character Breakdown</h6>
                    <div class="row small">
                        <div class="col-6">
                            <div>Hiragana: {{ lang_analysis.hiragana_count }}</div>
                            <div>Katakana: {{ lang_analysis.katakana_count }}</div>
                        </div>
                        <div class="col-6">
                            <div>Kanji: {{ lang_analysis.kanji_count }}</div>
                            <div>ASCII: {{ lang_analysis.ascii_count }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-3">
                        <button class="btn btn-nes btn-lg" onclick="createProject()">
                            <i class="bi bi-plus-circle"></i> Create Project
                        </button>
                        
                        <a href="{{ url_for('main.tile_browser', project_name=filename.rsplit('.', 1)[0]) }}" 
                           class="btn btn-outline-info btn-lg">
                            <i class="bi bi-grid-3x3"></i> Browse Tiles
                        </a>
                        
                        <button class="btn btn-outline-secondary btn-lg" onclick="downloadAnalysis()">
                            <i class="bi bi-download"></i> Download Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Font Regions -->
    {% if chr_analysis.font_regions %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-fonts"></i> Detected Font Regions</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-dark">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Start Tile</th>
                                    <th>End Tile</th>
                                    <th>Tile Count</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for region in chr_analysis.font_regions %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>0x{{ '%04X'|format(region.start_tile) }}</td>
                                    <td>0x{{ '%04X'|format(region.end_tile) }}</td>
                                    <td>{{ region.tile_count }}</td>
                                    <td>
                                        {% if region.notes %}
                                            <span class="badge bg-info">{{ region.notes }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Font</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Create Project Modal -->
<div class="modal fade" id="createProjectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">Create New Project</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Project Name</label>
                    <input type="text" class="form-control" id="projectName" 
                           value="{{ filename.rsplit('.', 1)[0]|replace(' ', '_')|replace('-', '_') }}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Character Table</label>
                    <div class="input-group">
                        <select class="form-select" id="tableFile">
                            <option value="tables/common.tbl">Loading tables...</option>
                        </select>
                        <button type="button" class="btn btn-outline-warning" onclick="generateTable()" 
                                title="Auto-generate table based on ROM analysis">
                            <i class="bi bi-magic"></i> Generate
                        </button>
                    </div>
                    <small class="text-muted">
                        Auto-generate a table based on detected language: 
                        <strong id="detectedLang">{{ lang_analysis.primary_language.value }}</strong>
                    </small>
                </div>
                <div id="tableGenStatus" class="alert alert-info d-none">
                    <i class="bi bi-hourglass-split"></i> <span id="tableGenMessage">Generating table...</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-nes" onclick="submitCreateProject()">
                    Create & Extract
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const filename = "{{ filename }}";
    const detectedLanguage = "{{ lang_analysis.primary_language.value }}";
    
    // Load available tables on page load
    document.addEventListener('DOMContentLoaded', loadTables);
    
    async function loadTables() {
        try {
            const response = await fetch('/api/tables');
            const data = await response.json();
            
            const select = document.getElementById('tableFile');
            select.innerHTML = '';
            
            if (data.tables && data.tables.length > 0) {
                data.tables.forEach(table => {
                    const option = document.createElement('option');
                    option.value = table.path;
                    option.textContent = table.name;
                    if (table.path === 'tables/common.tbl') {
                        option.textContent += ' (default)';
                    }
                    select.appendChild(option);
                });
            } else {
                select.innerHTML = '<option value="tables/common.tbl">Common (default)</option>';
            }
        } catch (error) {
            console.error('Error loading tables:', error);
        }
    }
    
    async function generateTable() {
        const statusDiv = document.getElementById('tableGenStatus');
        const statusMsg = document.getElementById('tableGenMessage');
        const projectName = document.getElementById('projectName').value;
        
        statusDiv.classList.remove('d-none', 'alert-success', 'alert-danger');
        statusDiv.classList.add('alert-info');
        statusMsg.innerHTML = '<i class="bi bi-hourglass-split"></i> Generating table for ' + projectName + '...';
        
        try {
            const response = await fetch('/api/generate-table', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    rom_filename: filename,
                    game_name: projectName,
                    language: detectedLanguage
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                statusDiv.classList.remove('alert-info');
                statusDiv.classList.add('alert-success');
                statusMsg.innerHTML = `<i class="bi bi-check-circle"></i> Generated table with ${result.mappings_count} character mappings (${result.language})`;
                
                // Reload tables and select the new one
                await loadTables();
                document.getElementById('tableFile').value = result.table_path;
            } else {
                throw new Error(result.error);
            }
        } catch (error) {
            statusDiv.classList.remove('alert-info');
            statusDiv.classList.add('alert-danger');
            statusMsg.innerHTML = '<i class="bi bi-x-circle"></i> Error: ' + error.message;
        }
    }
    
    function createProject() {
        new bootstrap.Modal(document.getElementById('createProjectModal')).show();
    }
    
    async function submitCreateProject() {
        const projectName = document.getElementById('projectName').value;
        const tableFile = document.getElementById('tableFile').value;
        
        showLoading('Extracting text from ROM...');
        
        try {
            const result = await apiCall('/api/extract', 'POST', {
                rom_filename: filename,
                output_name: projectName,
                table_file: tableFile
            });
            
            hideLoading();
            
            if (result.success) {
                window.location.href = `/projects/${result.project_name}`;
            } else {
                alert('Error: ' + result.error);
            }
        } catch (error) {
            hideLoading();
            alert('Error creating project: ' + error);
        }
    }
    
    function downloadAnalysis() {
        // Generate and download analysis report
        const report = {
            filename: filename,
            chr_analysis: {{ chr_analysis|tojson }},
            lang_analysis: {{ lang_analysis|tojson }}
        };
        
        const blob = new Blob([JSON.stringify(report, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename.replace('.nes', '_analysis.json');
        a.click();
        URL.revokeObjectURL(url);
    }
</script>
{% endblock %}
