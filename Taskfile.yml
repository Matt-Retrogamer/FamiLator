# FamiLator Task Runner Configuration
# https://taskfile.dev

version: '3'

vars:
  PROJECT_NAME: FamiLator
  PYTHON: ".venv/bin/python"
  UV: "uv"
  SOURCE_DIR: "src"
  TEST_DIR: "tests"
  CONFIG_DIR: "configs"
  OUTPUT_DIR: "output"
  TABLES_DIR: "tables"
  ROMS_DIR: "roms_input"
  TEST_ROM: "roms_input/test.nes"
  TEST_CONFIG: "configs/test.yaml"

tasks:
  # === Environment Setup ===
  
  setup:
    desc: Initial project setup (create venv and install dependencies)
    cmds:
      - echo "ğŸš€ Setting up FamiLator development environment..."
      - export PATH="$HOME/.local/bin:$PATH" && {{.UV}} sync --extra dev
      - echo "âœ… Environment setup complete!"
      - echo "ğŸ’¡ Run 'source .venv/bin/activate' to activate the virtual environment"

  install:
    desc: Install/upgrade dependencies
    deps: [check-venv]
    cmds:
      - export PATH="$HOME/.local/bin:$PATH" && {{.UV}} sync

  install-dev:
    desc: Install development dependencies
    deps: [check-venv]
    cmds:
      - export PATH="$HOME/.local/bin:$PATH" && {{.UV}} sync --extra dev

  check-venv:
    desc: Check if virtual environment exists
    cmds:
      - test -d .venv || (echo "âŒ Virtual environment not found. Run 'task setup' first." && exit 1)
    silent: true

  # === Core Operations ===

  extract:
    desc: Extract text from ROM
    deps: [install]
    cmds:
      - echo "ğŸ“ Extracting text from ROM..."
      - "{{.PYTHON}} -m src.extractor {{.CLI_ARGS}}"
    requires:
      vars: [CLI_ARGS]

  translate:
    desc: Translate extracted text
    deps: [install]
    cmds:
      - echo "ğŸŒ Translating text..."
      - "{{.PYTHON}} -m src.translator_stub {{.CLI_ARGS}}"
    requires:
      vars: [CLI_ARGS]

  reinject:
    desc: Reinject translated text into ROM
    deps: [install]
    cmds:
      - echo "ğŸ’‰ Reinjecting translated text..."
      - "{{.PYTHON}} -m src.reinjector {{.CLI_ARGS}}"
    requires:
      vars: [CLI_ARGS]

  validate:
    desc: Validate ROM integrity
    deps: [install]
    cmds:
      - echo "ğŸ” Validating ROM..."
      - "{{.PYTHON}} -m src.validator {{.CLI_ARGS}}"
    requires:
      vars: [CLI_ARGS]

  pipeline:
    desc: Run full translation pipeline
    deps: [install]
    cmds:
      - echo "ğŸš€ Running complete translation pipeline..."
      - "{{.PYTHON}} scripts/run_pipeline.py {{.CLI_ARGS}}"
    requires:
      vars: [CLI_ARGS]

  # === Testing ===

  test:
    desc: Run all tests
    deps: [install-dev]
    cmds:
      - echo "ğŸ§ª Running tests..."
      - "{{.PYTHON}} -m pytest {{.TEST_DIR}} -v"

  test-unit:
    desc: Run unit tests only
    deps: [install-dev]
    cmds:
      - "{{.PYTHON}} -m pytest {{.TEST_DIR}} -v -k 'not integration'"

  test-integration:
    desc: Run integration tests only
    deps: [install-dev]
    cmds:
      - "{{.PYTHON}} -m pytest {{.TEST_DIR}} -v -k 'integration'"

  test-coverage:
    desc: Run tests with coverage report
    deps: [install-dev]
    cmds:
      - "{{.PYTHON}} -m coverage run -m pytest {{.TEST_DIR}}"
      - "{{.PYTHON}} -m coverage report"
      - "{{.PYTHON}} -m coverage html"

  # === Code Quality ===

  lint:
    desc: Run linting
    deps: [install-dev]
    cmds:
      - "{{.PYTHON}} -m flake8 {{.SOURCE_DIR}} {{.TEST_DIR}}"

  format:
    desc: Format code
    deps: [install-dev]
    cmds:
      - "{{.PYTHON}} -m black {{.SOURCE_DIR}} {{.TEST_DIR}}"
      - "{{.PYTHON}} -m isort {{.SOURCE_DIR}} {{.TEST_DIR}}"

  format-check:
    desc: Check code formatting
    deps: [install-dev]
    cmds:
      - "{{.PYTHON}} -m black --check {{.SOURCE_DIR}} {{.TEST_DIR}}"
      - "{{.PYTHON}} -m isort --check-only {{.SOURCE_DIR}} {{.TEST_DIR}}"

  type-check:
    desc: Run type checking
    deps: [install-dev]
    cmds:
      - "{{.PYTHON}} -m mypy {{.SOURCE_DIR}}"

  quality:
    desc: Run all quality checks
    deps: [lint, format-check, type-check, test]

  # === Analysis ===

  analyze:
    desc: Analyze ROM structure
    deps: [install]
    cmds:
      - echo "ğŸ”¬ Analyzing ROM structure..."
      - "{{.PYTHON}} -m src.detector {{.CLI_ARGS}}"
    requires:
      vars: [CLI_ARGS]

  # === New Streamlined Commands ===

  tr:
    desc: "Quick translate: task tr -- game.nes [source] [target]"
    deps: [install]
    cmds:
      - "{{.PYTHON}} -m src.cli translate --rom {{.CLI_ARGS}} --auto --mock"

  translate-rom:
    desc: Translate ROM with full options
    deps: [install]
    cmds:
      - "{{.PYTHON}} -m src.cli translate {{.CLI_ARGS}}"
    requires:
      vars: [CLI_ARGS]

  projects:
    desc: List all translation projects
    deps: [install]
    cmds:
      - "{{.PYTHON}} -m src.cli list --projects"

  roms:
    desc: List available ROMs
    deps: [install]
    cmds:
      - "{{.PYTHON}} -m src.cli list --roms"

  project-status:
    desc: Show status of a project
    deps: [install]
    cmds:
      - "{{.PYTHON}} -m src.cli status --project {{.CLI_ARGS}}"
    requires:
      vars: [CLI_ARGS]

  apply-translations:
    desc: Apply edited translations to ROM
    deps: [install]
    cmds:
      - "{{.PYTHON}} -m src.cli apply --project {{.CLI_ARGS}}"
    requires:
      vars: [CLI_ARGS]

  demo:
    desc: Run demonstration with test ROM (mock translation)
    deps: [install]
    cmds:
      - echo "ğŸ•¹ï¸  FamiLator Demo"
      - echo "=================="
      - echo
      - echo "ğŸš€ Running full translation pipeline with test ROM..."
      - "{{.PYTHON}} -m src.cli translate --rom {{.TEST_ROM}} --source Japanese --target English --auto --mock"
      - echo
      - echo "ğŸ‰ Demo complete! Check the {{.OUTPUT_DIR}}/ directory for results."
      - ls -la {{.OUTPUT_DIR}}/

  demo-legacy:
    desc: Run demo with legacy pipeline script
    deps: [install]
    cmds:
      - "{{.PYTHON}} scripts/run_pipeline.py {{.TEST_ROM}} {{.TEST_CONFIG}} --mock-translate"

  # === Web Interface ===

  web:
    desc: "Start the web interface (default: http://127.0.0.1:5000)"
    deps: [install]
    cmds:
      - echo "ğŸŒ Starting FamiLator Web Interface..."
      - "{{.PYTHON}} scripts/run_web.py {{.CLI_ARGS}}"

  web-dev:
    desc: Start web interface in debug mode with auto-reload
    deps: [install-dev]
    cmds:
      - echo "ğŸŒ Starting FamiLator Web Interface (debug mode)..."
      - "{{.PYTHON}} scripts/run_web.py --debug"

  # === Statistics ===

  show-stats:
    desc: Show project statistics
    cmds:
      - echo "ğŸ“Š FamiLator Project Statistics"
      - echo "==============================="
      - echo
      - echo "ğŸ“ Code files:"
      - find {{.SOURCE_DIR}} -name "*.py" | wc -l | xargs echo "  Python files:"
      - find {{.TEST_DIR}} -name "*.py" | wc -l | xargs echo "  Test files:"
      - echo
      - echo "ğŸ“ Lines of code:"
      - "find {{.SOURCE_DIR}} -name \"*.py\" -exec wc -l {} + | tail -1 | awk '{print \"  Source: \" $1}'"
      - "find {{.TEST_DIR}} -name \"*.py\" -exec wc -l {} + | tail -1 | awk '{print \"  Tests: \" $1}'"
      - echo
      - echo "ğŸ® Game configurations:"
      - ls {{.CONFIG_DIR}}/*.yaml | wc -l | xargs echo "  Config files:"
      - echo
      - echo "ğŸ“š Encoding tables:"
      - ls {{.TABLES_DIR}}/*.tbl | wc -l | xargs echo "  Table files:"

  # === Maintenance ===

  clean:
    desc: Clean generated files
    cmds:
      - echo "ğŸ§¹ Cleaning generated files..."
      - rm -rf build/ dist/ *.egg-info/
      - rm -rf {{.OUTPUT_DIR}}/*
      - find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
      - find . -name "*.pyc" -delete
      - rm -rf .coverage htmlcov/
      - echo "âœ… Cleanup complete!"

  clean-all:
    desc: Clean everything including virtual environment
    cmds:
      - task: clean
      - rm -rf .venv/
      - echo "âœ… Full cleanup complete!"

  # === Documentation ===

  docs:
    desc: Generate documentation
    deps: [install-dev]
    cmds:
      - echo "ğŸ“š Generating documentation..."
      - mkdir -p docs
      - echo "Documentation generation not yet implemented"

  # === Help ===

  help:
    desc: Show detailed help information
    cmds:
      - echo "ğŸ® FamiLator - NES ROM Translation Tool"
      - echo "======================================"
      - echo
      - echo "âš¡ QUICK START (new streamlined workflow):"
      - echo "  task demo                             - Run demo with test ROM"
      - echo "  task tr -- game.nes                   - Quick translate (auto + mock)"
      - echo "  task translate-rom -- --rom game.nes --source Japanese --target English"
      - echo
      - echo "ğŸ“ Project Management:"
      - echo "  task projects                         - List all projects"
      - echo "  task roms                             - List available ROMs"
      - echo "  task project-status -- output/myproj  - Show project status"
      - echo "  task apply-translations -- output/myproj  - Apply edited translations"
      - echo
      - echo "ğŸš€ Getting Started:"
      - echo "  setup       - Initial environment setup"
      - echo "  demo        - Run demonstration"
      - echo
      - echo "ğŸ”§ Development:"
      - echo "  install     - Install dependencies"
      - echo "  install-dev - Install development dependencies"  
      - echo "  test        - Run tests"
      - echo "  pipeline    - Full translation pipeline (legacy)"
      - echo
      - echo "ğŸ¯ Legacy Operations:"
      - echo "  extract     - Extract text from ROM"
      - echo "  translate   - Translate extracted text"
      - echo "  reinject    - Reinject translated text"
      - echo "  validate    - Validate ROM integrity"
      - echo
      - echo "âœ¨ Quality:"
      - echo "  lint        - Run linting"
      - echo "  format      - Format code"
      - echo "  type-check  - Run type checking"
      - echo "  quality     - All quality checks"
      - echo
      - echo "ğŸ§¹ Maintenance:"
      - echo "  clean       - Clean generated files"
      - echo
      - echo "ğŸ“– Direct CLI usage:"
      - echo "  .venv/bin/familator translate --rom game.nes --source japanese --target english --auto"
      - echo
      - "echo \"For all tasks: task --list-all\""

  default:
    desc: Show help by default
    cmds:
      - task: help
